uploadPresignedUrl:
    handler: src/functions/uploadPresignedUrl.handler
    events:
        - httpApi:
              path: /upload-url
              method: post
              authorizer:
                  name: jwtCognitoAuthorizer
    iamRoleStatements:
        - Effect: Allow
          Action:
              - dynamodb:PutItem
          Resource:
              Fn::GetAtt: [ImagesTable, Arn]
        - Effect: Allow
          Action:
              - s3:PutObject
          Resource:
              Fn::Sub: 'arn:aws:s3:::${self:custom.s3ImagesBucket}/uploads/*'
deleteImage:
    handler: src/functions/deleteImage.handler
    events:
        - httpApi:
              path: /image
              method: delete
              authorizer:
                  name: jwtCognitoAuthorizer
getImages:
    handler: src/functions/getImages.handler
    events:
        - httpApi:
              path: /images
              method: get
processImage:
    handler: src/functions/processImage.handler
    events:
        - s3:
              bucket: ${self:custom.s3ImagesBucket}
              event: s3:ObjectCreated:Put
              rules:
                  - prefix: uploads/
              existing: true
    iamRoleStatements:
        - Effect: Allow
          Action:
              - dynamodb:Query
              - dynamodb:UpdateItem
          Resource:
              Fn::GetAtt: [ImagesTable, Arn]
        - Effect: Allow
          Action:
              - dynamodb:BatchWriteItem
          Resource:
              Fn::GetAtt: [LabelsTable, Arn]
        - Effect: Allow
          Action:
              - rekognition:DetectLabels
              - rekognition:IndexFaces
          Resource:
              Fn::Sub: 'arn:aws:rekognition:${aws:region}:${aws:accountId}:collection/${self:custom.rekognitionCollectionId}'
